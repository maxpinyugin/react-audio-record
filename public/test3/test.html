<!DOCTYPE html>
<html>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<head>
    <title>Host that loads a plugin with its GUI</title>
    <script
            src="https://mainline.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js">
    </script>
</head>
<body>
Test
</body>
<script type="text/javascript">
    function listDevices(callback) {
        var devices = navigator.mediaDevices;
        if (devices && 'enumerateDevices' in devices) {
            var promise = devices.enumerateDevices();
            promise
                .then(function(devices) {
                    var video = [];
                    var audio = [];
                    for (var i = 0; i < devices.length; ++i) {
                        var device = devices[i];
                        switch (device.kind) {
                            case 'videoinput': video.push(device); break;
                            case 'audioinput': audio.push(device); break;
                        }
                    };
                    var devices = {
                        video: video,
                        audio: audio
                    };
                    callback(null, devices);
                })
                .catch(function(error) {
                    callback(`${error.name}: ${error.message}`, null);
                });
        } else {
            callback(`Media Devices API is not supported.`, null);
        }
    }

    listDevices(function(error, devices) {
        if (error) {
            console.error(error);
        } else {
            var video = devices.video;  // input video devices as array (e.g. web cameras)
            var audio = devices.audio;  // input audio devices as array (e.g. microphones)
            console.log('video: ' + JSON.stringify(video, null, 4));
            console.log('audio: ' + JSON.stringify(audio, null, 4));
        }
    });
</script>

<script type="module">

    import DSP from "./main.js";

    var ctx = new AudioContext();
    var audioSource;
    var mediaStream;

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {



        navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: false,
                deviceId: "default"
            }
        })
            .then(function (stream) {
                mediaStream = stream

                audioSource = ctx.createMediaStreamSource(mediaStream);


                var mediaSource = ctx.createMediaStreamSource(mediaStream);
                var pluginURL = ".";
                var plugin = new DSP(ctx, pluginURL);

                plugin.load().then((node) => {
                    plugin.loadGui().then((elem) => {
                        document.body.appendChild(elem);

                    });
                    console.log(node.getDescriptor());
                    mediaSource.connect(node);
                    node.connect(ctx.destination);

                    console.log(audioSource);

                    audioSource.connect(node);
                });

            })
            .catch((e) => {
                alert('Error getting audio input');
                console.log(e);
            });
    } else {
        alert('Audio input API not available');
    }





</script>

</html>